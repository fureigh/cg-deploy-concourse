---
name: concourse

# Meta property overrides
meta:
  environment: ~
  az: ~
  atc:
    external_url: ~
  network:
    reserved: ~
    dns: ~
  resources:
    web:
      instance_type: ~
      elbs: ~
    workers:
      instance_type: ~
  compilation:
    instance_type: ~
    disk:
      size: ~
      type: ~
  riemann_emitter:
    host: ~
    port: 5555
  rds:
    region: ~

# replace with bosh status --uuid
director_uuid: ~

# replace all addresses with your VPC range
#
# e.g. X.X.0.2 -> 10.0.0.2
networks:
- name: concourse
  type: manual
  subnets:
  - (( inline ))
  - reserved: (( grab meta.network.reserved ))
    dns: (( grab meta.network.dns ))

releases:
- {name: concourse, version: latest}
- {name: garden-runc, version: latest}
- {name: riemann, version: latest}

instance_groups:
- name: web
  instances: 1
  resource_pool: web
  networks: [{name: concourse}]
  jobs:
  - name: atc
    release: concourse
    properties:
      web_bind_port: 8080
      external_url: (( grab meta.atc.external_url ))
  - name: tsa
    release: concourse
    properties: {}
  - name: riemann-emitter
    release: riemann
    properties:
      riemann_emitter:
        host: (( grab meta.riemann_emitter.host ))
        port: (( grab meta.riemann_emitter.port ))
        health: true

- &worker
  name: worker
  instances: 1
  resource_pool: workers
  networks: [{name: concourse}]
  jobs: &worker-jobs
  - release: concourse
    name: groundcrew
  - release: concourse
    name: baggageclaim
    properties: {}
  - release: garden-runc
    name: garden
    properties:
      garden:
        listen_network: tcp
        listen_address: 0.0.0.0:7777
        enable_graph_cleanup: true
        default_container_grace_time: 10m
        max_containers: 250
        network_pool: 10.254.0.0/20
  - release: riemann
    name: riemann-emitter
    properties:
      riemann_emitter:
        host: (( grab meta.riemann_emitter.host ))
        port: (( grab meta.riemann_emitter.port ))
        health: true
- <<: *worker
  name: iaas-worker
  resource_pool: iaas-workers
  properties:
    tags:
    - iaas


resource_pools:
- name: web
  network: concourse
  stemcell: &stemcell
    name: bosh-aws-xen-hvm-ubuntu-trusty-go_agent
    version: latest
  cloud_properties:
    availability_zone: &az (( grab meta.az ))
    instance_type: (( grab meta.resources.web.instance_type ))
    ephemeral_disk:
      size: 45000
      type: gp2
      encrypted: true

- &workers
  name: workers
  network: concourse
  stemcell: *stemcell
  cloud_properties:
    availability_zone: *az
    instance_type: (( grab meta.resources.workers.instance_type ))
    ephemeral_disk:
      size: 300000
      type: gp2
      encrypted: true

- <<: *workers
  name: iaas-workers

compilation:
  workers: 3
  network: concourse
  reuse_compilation_vms: true
  cloud_properties:
    availability_zone: *az
    instance_type: (( grab meta.compilation.instance_type ))
    ephemeral_disk:
      size: (( grab meta.compilation.disk.size ))
      type: (( grab meta.compilation.disk.type ))
      encrypted: true

update:
  canaries: 1
  max_in_flight: 1
  serial: false
  canary_watch_time: 1000-600000
  update_watch_time: 1000-600000
